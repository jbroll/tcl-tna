#!/usr/bin/env tclkit8.6
#
lappend auto_path /Users/john/lib lib

package require tcltest
package require arec



::tcltest::configure -testdir [file dirname [file normalize [info script]]] -singleproc 1

::tcltest::test rec { dtype size     } -body { arec::dtype size } -result 20

::tcltest::test rec { dtype types    } -body { arec::dtype types  } -result {string int int}
::tcltest::test rec { dtype names    } -body { arec::dtype names  } -result {name size align}
::tcltest::test rec { dtype fields   } -body { arec::dtype fields } -result {string name int size int align}


::tcltest::test rec { dtypes length  } -body { arec::dtypes length } -result 8
::tcltest::test rec { dtypes get     } -body { arec::dtypes 0 end get     } -result {{char 1 1} {uchar 1 1} {short 2 2} {ushort 2 2} {int 4 4} {float 4 4} {double 8 4} {string 4 4}}
::tcltest::test rec { dtypes getlist } -body { arec::dtypes 0 end getlist } -result {{char 1 1} {uchar 1 1} {short 2 2} {ushort 2 2} {int 4 4} {float 4 4} {double 8 4} {string 4 4}}
::tcltest::test rec { dtypes getdict } -body { arec::dtypes 0 end getdict } -result {{name char size 1 align 1} {name uchar size 1 align 1} {name short size 2 align 2} {name ushort size 2 align 2} {name int size 4 align 4} {name float size 4 align 4} {name double size 8 align 4} {name string size 4 align 4}}


foreach type [arec::dtypes 0 end get name] reply { 1 1 1 1 1 1.0 1.0 1 } {
    ::tcltest::test rec "each type: $type" -body {
	arec::typedef blink [subst { $type 	count }]

	blink new blonk 1
	blonk set count 1
	blonk get count
    } -cleanup { rename blink {}; rename blonk {}
    } -result $reply
}


foreach i { 0 1 2 3 4 5 6 7 8 9 0 } {
    ::tcltest::test rec { new type } -body {
	arec::typedef blink {
	    int 	count
	    int 	bunk
	    double  chunk
	}
	blink new blonk 4

	blonk 0 end set count 4
	blonk 0 end set bunk  4
	blonk 0 end set chunk 3.3

	blonk 0 set count 6
	blonk 3 set chunk 5.5

	blonk 0 end get
    } -cleanup { rename blonk {}
    } -result {{6 4 3.3} {4 4 3.3} {4 4 3.3} {4 4 5.5}}
}


::tcltest::test length { length+1 } -body {
    arec::typedef blink {
	double a
	int    b
	double c
    }

    blink new blonk 5

    blonk 0 end set a 3.3
    blonk 0 end set b 3
    blonk 0 end set c 5.5


    blonk end+1 set a 6
    blonk end+1 set a 7
    blonk end+1 set a 8
    blonk end+1 set a 9

    blonk 0 end get
} -cleanup {
} -result  "[lrepeat 5 {3.3 3 5.5}] {6.0 0 0.0} {7.0 0 0.0} {8.0 0 0.0} {9.0 0 0.0}"

